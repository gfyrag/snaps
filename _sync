#!/bin/bash

set -x

[ $1 ] || {
	echo "Missing workdir"
	exit 1
}

[ $2 ] || {
	echo "Missing dest dir"
}

workdir=$(readlink -m $1)
scriptlocation=$(dirname "${BASH_SOURCE[0]}")
dest=$2
rosnapsdir=$workdir/ro

mkdir -p $rosnapsdir

for p in $(ls $workdir/snaps); do
	btrfs sub snapshot -r $workdir/snaps/$p $rosnapsdir/$p
done
sync

firstSnapshot=$(ls $rosnapsdir | head -1)

mkdir -p $dest
test -e $dest/$firstSnapshot
if [ "$?" != 0 ]; then # First snapshot not found
	btrfs send $rosnapsdir/$firstSnapshot |sudo btrfs receive $dest
fi

previous=$firstSnapshot
for p in $(ls $rosnapsdir | tail -n +2); do
	btrfs send -p $rosnapsdir/$previous $rosnapsdir/$p |sudo btrfs receive $dest
	previous=$p
done

for p in $(ls $rosnapsdir); do
	btrfs sub del $rosnapsdir/$p
done
sync

rmdir $rosnapsdir
